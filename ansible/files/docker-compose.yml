services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - monitoring

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ./grafana/datasources:/etc/grafana/provisioning/datasources:ro
    networks:
      - monitoring
    depends_on:
      - prometheus

  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    restart: unless-stopped
    ports:
      - "9100:9100"
    networks:
      - monitoring

networks:
  monitoring:
    driver: bridge

volumes:
  prometheus_data:
    driver: local


# version: '3.8'

# # =====================================================================
# # Production-Ready Docker Compose for Python App + Observability Stack
# # =====================================================================

# services:
#   # # ===================================================================
#   # # 1. Python Application
#   # # ===================================================================
#   # python-app:
#   #   container_name: python-app
#   #   build:
#   #     context: .
#   #     cache_from:
#   #       - python-app:latest
#   #   restart: unless-stopped
#   #   ports:
#   #     - "${APP_PORT:-5000}:5000"
#   #   networks:
#   #     - app-network
#   #     - monitoring-network
#   #   environment:
#   #     - FLASK_ENV=${FLASK_ENV:-production}
#   #     - FLASK_DEBUG=${FLASK_DEBUG:-False}
#   #   healthcheck:
#   #     test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
#   #     interval: 30s
#   #     timeout: 10s
#   #     retries: 3
#   #     start_period: 40s
#   #   deploy:
#   #     resources:
#   #       limits:
#   #         cpus: '1.0'
#   #         memory: 512M
#   #       reservations:
#   #         cpus: '0.5'
#   #         memory: 256M
#   #   logging:
#   #     driver: "json-file"
#   #     options:
#   #       max-size: "10m"
#   #       max-file: "3"
#   #   labels:
#   #     - "com.example.service=python-app"
#   #     - "com.example.environment=${ENVIRONMENT:-production}"

#   # ===================================================================
#   # 2. Node Exporter (Hardware Metrics)
#   # ===================================================================
#   node-exporter:
#     image: prom/node-exporter:latest
#     container_name: node-exporter
#     restart: unless-stopped
#     volumes:
#       - /proc:/host/proc:ro
#       - /sys:/host/sys:ro
#       - /:/rootfs:ro
#     command:
#       - '--path.procfs=/host/proc'
#       - '--path.rootfs=/rootfs'
#       - '--path.sysfs=/host/sys'
#       - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
#     ports:
#       - "${NODE_EXPORTER_PORT:-9100}:9100"
#     networks:
#       - monitoring-network
#     healthcheck:
#       test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9100/"]
#       interval: 30s
#       timeout: 10s
#       retries: 3
#       start_period: 10s
#     deploy:
#       resources:
#         limits:
#           cpus: '0.5'
#           memory: 128M
#     logging:
#       driver: "json-file"
#       options:
#         max-size: "5m"
#         max-file: "2"
#     labels:
#       - "com.example.service=node-exporter"
#       - "com.example.monitoring=true"

#   # ===================================================================
#   # 3. Prometheus (Metrics Database)
#   # ===================================================================
#   prometheus:
#     image: prom/prometheus:latest
#     container_name: prometheus
#     restart: unless-stopped
#     user: "nobody"  # Run as non-root
#     volumes:
#       - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
#       - prometheus_data:/prometheus
#     ports:
#       - "${PROMETHEUS_PORT:-9090}:9090"
#     command:
#       - '--config.file=/etc/prometheus/prometheus.yml'
#       - '--storage.tsdb.path=/prometheus'
#       - '--storage.tsdb.retention.time=${PROMETHEUS_RETENTION:-30d}'
#       - '--web.console.libraries=/etc/prometheus/console_libraries'
#       - '--web.console.templates=/etc/prometheus/consoles'
#       - '--web.enable-lifecycle'
#     networks:
#       - monitoring-network
#     depends_on:
#       node-exporter:
#         condition: service_healthy
#       python-app:
#         condition: service_healthy
#     healthcheck:
#       test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
#       interval: 30s
#       timeout: 10s
#       retries: 3
#       start_period: 30s
#     deploy:
#       resources:
#         limits:
#           cpus: '1.0'
#           memory: 1G
#         reservations:
#           cpus: '0.5'
#           memory: 512M
#     logging:
#       driver: "json-file"
#       options:
#         max-size: "10m"
#         max-file: "3"
#     labels:
#       - "com.example.service=prometheus"
#       - "com.example.monitoring=true"

#   # ===================================================================
#   # 4. Grafana (Visualization Dashboard)
#   # ===================================================================
#   grafana:
#     image: grafana/grafana:latest
#     container_name: grafana
#     restart: unless-stopped
#     user: "472"  # Grafana user
#     ports:
#       - "${GRAFANA_PORT:-3000}:3000"
#     volumes:
#       - grafana_data:/var/lib/grafana
#       - ./grafana/datasources:/etc/grafana/provisioning/datasources:ro
#     environment:
#       # Security
#       - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
#       - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-changeme}
#       - GF_USERS_ALLOW_SIGN_UP=false
#       - GF_SECURITY_DISABLE_GRAVATAR=true
      
#       # Server
#       - GF_SERVER_ROOT_URL=http://localhost:${GRAFANA_PORT:-3000}
#       - GF_SERVER_ENFORCE_DOMAIN=false
      
#       # Analytics
#       - GF_ANALYTICS_REPORTING_ENABLED=false
#       - GF_ANALYTICS_CHECK_FOR_UPDATES=false
      
#       # Logging
#       - GF_LOG_LEVEL=${GRAFANA_LOG_LEVEL:-info}
#       - GF_LOG_MODE=console
#     networks:
#       - monitoring-network
#     depends_on:
#       prometheus:
#         condition: service_healthy
#     healthcheck:
#       test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
#       interval: 30s
#       timeout: 10s
#       retries: 3
#       start_period: 40s
#     deploy:
#       resources:
#         limits:
#           cpus: '1.0'
#           memory: 512M
#         reservations:
#           cpus: '0.5'
#           memory: 256M
#     logging:
#       driver: "json-file"
#       options:
#         max-size: "10m"
#         max-file: "3"
#     labels:
#       - "com.example.service=grafana"
#       - "com.example.monitoring=true"

# # =====================================================================
# # Networks
# # =====================================================================
# networks:
#   app-network:
#     driver: bridge
#     labels:
#       - "com.example.network=application"
  
#   monitoring-network:
#     driver: bridge
#     labels:
#       - "com.example.network=monitoring"

# # =====================================================================
# # Persistent Volumes
# # =====================================================================
# volumes:
#   prometheus_data:
#     driver: local
#     labels:
#       - "com.example.volume=prometheus-data"
  
#   grafana_data:
#     driver: local
#     labels:
#       - "com.example.volume=grafana-data"